!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","stratus.services.model"],e):e(t.Stratus,t._,t.angular)}(this,function(t,e,i){t.Services.Collection=["$provide",function(s){s.factory("Collection",["$http","$mdToast","$timeout","Model",function(s,n,o,r){return class{constructor(s){this.target=null,this.direct=!1,this.infinite=!1,this.threshold=.5,this.qualifier="",this.decay=0,this.urlRoot="/Api",s&&"object"==typeof s&&i.extend(this,s),this.header=new t.Prototypes.Model,this.meta=new t.Prototypes.Model,this.model=r,this.models=[],this.types=[],this.pending=!1,this.error=!1,this.completed=!1,this.filtering=!1,this.paginate=!1,this.target&&(this.urlRoot+="/"+e.ucfirst(this.target)),this.serialize=this.serialize.bind(this),this.url=this.url.bind(this),this.inject=this.inject.bind(this),this.sync=this.sync.bind(this),this.fetch=this.fetch.bind(this),this.filter=this.filter.bind(this),this.throttleFilter=this.throttleFilter.bind(this),this.page=this.page.bind(this),this.toJSON=this.toJSON.bind(this),this.add=this.add.bind(this),this.remove=this.remove.bind(this),this.find=this.find.bind(this),this.pluck=this.pluck.bind(this),this.exists=this.exists.bind(this),this.throttle=e.throttle(this.fetch,1e3)}serialize(t,e){const s=this,n=[];return t=t||{},i.forEach(t,function(t,o){if(i.isObject(t))e&&(o=e+"["+o+"]"),n.push(s.serialize(t,o));else{let i="";e&&(i+=e+"["),i+=o,e&&(i+="]"),n.push(i+"="+t)}}),n.join("&")}url(){return this.urlRoot+(this.targetSuffix||"")}inject(t,i){if(!e.isArray(t))return;-1===this.types.indexOf(i)&&this.types.push(i);const s=this;t.forEach(function(t){s.models.push(new r({collection:this,type:i||null},t))})}sync(n,o,r){const h=this;return this.pending=!0,this.completed=!1,new Promise(function(a,c){r=r||{};const l={method:n=n||"GET",url:h.url(),headers:{}};i.isDefined(o)&&("GET"===n?i.isObject(o)&&Object.keys(o).length&&(l.url+=l.url.includes("?")?"&":"?",l.url+=h.serialize(o)):(l.headers["Content-Type"]="application/json",l.data=JSON.stringify(o))),r.hasOwnProperty("headers")&&"object"==typeof r.headers&&Object.keys(r.headers).forEach(function(t){l.headers[t]=r.headers[t]}),s(l).then(function(s){if(200===s.status&&i.isObject(s.data)){h.header.set(s.headers()||{}),h.meta.set(s.data.meta||{}),h.models=[];const t=s.data.payload||s.data;h.direct?h.models=t:e.isArray(t)?h.inject(t):e.isObject(t)?e.each(t,h.inject):console.error("malformed payload:",t),h.pending=!1,h.completed=!0,h.filtering=!1,h.paginate=!1,a(h.models)}else{h.pending=!1,h.error=!0;const i=new t.Prototypes.Error;i.payload=e.isObject(s.data)?s.data:s,s.statusText&&"OK"!==s.statusText?i.message=s.statusText:e.isObject(s.data)?i.message="Unknown AngularCollection error!":i.message=`Invalid Payload: ${l.method} ${l.url}`,c(i)}}).catch(function(t){throw console.error("XHR: "+l.method+" "+l.url),c(t),t})})}fetch(t,e,i){return this.sync(t,e||this.meta.get("api"),i).catch(function(t){n.show(n.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),console.error("FETCH:",t)})}filter(t){return this.filtering=!0,this.meta.set("api.q",i.isDefined(t)?t:""),this.meta.set("api.p",1),this.fetch()}throttleFilter(e){const s=this;return this.meta.set("api.q",i.isDefined(e)?e:""),new Promise(function(e,i){const n=s.throttle();t.Environment.get("production")||console.log("request:",n),n.then(function(i){t.Environment.get("production"),e(i)}).catch(i)})}page(t){this.paginate=!0,this.meta.set("api.p",t),this.fetch(),delete this.meta.get("api").p}toJSON(){const t=[];return this.models.forEach(function(e){"function"==typeof e.toJSON&&t.push(e.toJSON())}),t}add(t,e){if(!i.isObject(t))return;e&&"object"==typeof e||(e={});t=t instanceof r?t:new r({collection:this},t),this.models.push(t),e.save&&t.save()}remove(t){this.models.splice(this.models.indexOf(t),1)}find(t){return e.find(this.models,e.isFunction(t)?t:function(e){return e.get("id")===t})}pluck(t){return e.map(this.models,function(e){return e instanceof r?e.pluck(t):null})}exists(t){return!!e.reduce(this.pluck(t)||[],function(t,e){return t||i.isDefined(e)})}}}])}]});