!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.collection","stratus.services.model"],e):e(t.Stratus,t._,t.angular)}(this,function(t,e,a){t.Services.Registry=["$provide",function(a){a.factory("Registry",["Collection","Model","$interpolate",function(a,r,o){return t.Prototypes.AngularRegistry=t.Prototypes.AngularRegistry||class i{constructor(){this.fetch=this.fetch.bind(this)}fetch(a,r){return new Promise(function(n,c){"string"==typeof a&&(a={target:a});const l={target:a.attr?a.attr("data-target"):a.target,targetSuffix:a.attr?a.attr("data-target-suffix"):a.targetSuffix,id:a.attr?a.attr("data-id"):a.id,manifest:a.attr?a.attr("data-manifest"):a.manifest,decouple:a.attr?a.attr("data-decouple"):a.decouple,direct:a.attr?a.attr("data-direct"):a.direct,api:a.attr?a.attr("data-api"):a.api,urlRoot:a.attr?a.attr("data-url-root"):a.urlRoot};let u=0,s=function(){e.isNumber(u)&&u===e.size(l)&&n(i.build(l,r))};e.each(l,function(a,i){if(!a||"string"!=typeof a)return u++,void s();const n=o(a,!1,null,!0),c=n(r.$parent);if(void 0!==c)return l[i]=c,u++,void s();t.Environment.get("production")||console.log("poll attribute:",i),e.poll(function(){return n(r.$parent)},7500,250).then(function(e){t.Environment.get("production")||console.log("interpreted:",e),void 0!==e&&(l[i]=e,u++,s())}).catch(function(t){console.error(t)})})})}static build(o,i){let n;if(o.target){if(o.target=e.ucfirst(o.target),o.manifest||o.id){t.Catalog[o.target]||(t.Catalog[o.target]={});const e=o.id||"manifest";if(o.decouple||!t.Catalog[o.target][e]){const a={target:o.target,manifest:o.manifest,stagger:!0};o.urlRoot&&(a.urlRoot=o.urlRoot),o.targetSuffix&&(a.targetSuffix=o.targetSuffix),n=new r(a,{id:o.id}),o.decouple||(t.Catalog[o.target][e]=n)}else t.Catalog[o.target][e]&&(n=t.Catalog[o.target][e])}else{const e=o.direct?"Compendium":"Catalog";if(t[e][o.target]||(t[e][o.target]={}),o.decouple||!t[e][o.target].collection){const r={target:o.target,direct:!!o.direct};o.urlRoot&&(r.urlRoot=o.urlRoot),o.targetSuffix&&(r.targetSuffix=o.targetSuffix),n=new a(r),o.decouple||(t[e][o.target].collection=n)}else t[e][o.target].collection&&(n=t[e][o.target].collection)}o.api&&n.meta.set("api",e.isJSON(o.api)?JSON.parse(o.api):o.api),n.stagger&&"function"==typeof n.initialize&&n.initialize()}return"object"==typeof n&&null!==n&&(void 0!==i&&(i.data=n,n instanceof r?(i.model=n,i.model.on("change",function(){i.$apply()})):n instanceof a&&(i.collection=n)),n.pending||n.completed||n.fetch()),n}},new t.Prototypes.AngularRegistry}])}]});