!function(t,e){"function"==typeof define&&define.amd?define(["exports","stratus","underscore","angular","stratus.services.collection","stratus.services.model"],e):e(t.exports,t.Stratus,t._,t.angular,t.Collection,t.Model)}(this,function(t,e,a,r,o,i){let n=function(){console.error("$$interpolate not loaded:",arguments)};class c{constructor(){this.fetch=this.fetch.bind(this)}fetch(t,r){return new Promise(function(o,i){"string"==typeof t&&(t={target:t});const l={target:t.attr?t.attr("data-target"):t.target,targetSuffix:t.attr?t.attr("data-target-suffix"):t.targetSuffix,id:t.attr?t.attr("data-id"):t.id,manifest:t.attr?t.attr("data-manifest"):t.manifest,decouple:t.attr?t.attr("data-decouple"):t.decouple,direct:t.attr?t.attr("data-direct"):t.direct,api:t.attr?t.attr("data-api"):t.api,urlRoot:t.attr?t.attr("data-url-root"):t.urlRoot};let u=0,s=function(){a.isNumber(u)&&u===a.size(l)&&o(c.build(l,r))};a.each(l,function(t,o){if(!t||"string"!=typeof t)return u++,void s();const i=n(t,!1,null,!0),c=i(r.$parent);if(void 0!==c)return l[o]=c,u++,void s();e.Environment.get("production")||console.log("poll attribute:",o),a.poll(function(){return i(r.$parent)},7500,250).then(function(t){e.Environment.get("production")||console.log("interpreted:",t),void 0!==t&&(l[o]=t,u++,s())}).catch(function(t){console.error(t)})})})}static build(t,r){let n;if(t.target){if(t.target=a.ucfirst(t.target),t.manifest||t.id){e.Catalog[t.target]||(e.Catalog[t.target]={});const a=t.id||"manifest";if(t.decouple||!e.Catalog[t.target][a]){const r={target:t.target,manifest:t.manifest,stagger:!0};t.urlRoot&&(r.urlRoot=t.urlRoot),t.targetSuffix&&(r.targetSuffix=t.targetSuffix),n=new i(r,{id:t.id}),t.decouple||(e.Catalog[t.target][a]=n)}else e.Catalog[t.target][a]&&(n=e.Catalog[t.target][a])}else{const a=t.direct?"Compendium":"Catalog";if(e[a][t.target]||(e[a][t.target]={}),t.decouple||!e[a][t.target].collection){const r={target:t.target,direct:!!t.direct};t.urlRoot&&(r.urlRoot=t.urlRoot),t.targetSuffix&&(r.targetSuffix=t.targetSuffix),n=new o(r),t.decouple||(e[a][t.target].collection=n)}else e[a][t.target].collection&&(n=e[a][t.target].collection)}t.api&&n.meta.set("api",a.isJSON(t.api)?JSON.parse(t.api):t.api),n.stagger&&"function"==typeof n.initialize&&n.initialize()}return"object"==typeof n&&null!==n&&(void 0!==r&&(r.data=n,n instanceof i?(r.model=n,r.model.on("change",function(){console.log("changed:",r),r.$applyAsync()})):n instanceof o&&(r.collection=n)),n.pending||n.completed||n.fetch()),n}}return e.Services.Registry=["$provide",function(t){t.factory("Registry",["$interpolate",function(t){return n=t,new c}])}],e.Data.Registry=c,c,c});