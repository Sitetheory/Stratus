!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","backbone","backbone.relational","stratus.models.generic"],e):e(t.Stratus,t._,t.Backbone)}(this,function(t,e,i){t.Collections.Generic=i.Collection.extend({model:t.Models.Generic,meta:t.Prototypes.Model,url:"/Api",entity:"Unknown",_isHydrated:!1,initialize:function(t){if(e.has(this,"initialized")||(this.initialized=!1),this.initialized)return!0;t&&e.isObject(t)&&t.initialize&&this.safeInitialize(t)},safeInitialize:function(i){if(this.initialized)return!0;this.initialized=!0,this.globals=new t.Prototypes.Model,this.meta=new t.Prototypes.Model,e.has(i,"entity")&&(this.entity=i.entity),e.has(i,"target")&&(this.target=i.target),e.has(i,"api")&&(this.meta.set("api",i.api),this.api=i.api),e.has(i,"prototype")&&(this.prototype=i.prototype),this.target&&(e.has(this.target,"entity")&&(this.target=[this.target]),e.each(this.target,function(t){t.entity&&t.id&&(this.url=this.url+"/"+e.ucfirst(t.entity)+"/"+t.id)},this)),this.entity&&"Unknown"!==this.entity&&(this.url=this.url+"/"+this.entity,this.globals.set("entity",this.entity)),this.globals.set("uid",e.uniqueId("collection_")),this.refresh({reset:!0})},isHydrated:function(){return void 0!==this._isHydrated&&this._isHydrated},hydrateRelations:function(t,i,s){return t.type=this[t.type],e.has(t,"reverseRelation")&&e.has(t.reverseRelation,"type")&&(t.reverseRelation.type=this[t.reverseRelation.type]),t.type},hydrateType:function(i,s,n){var a=null,o=null;e.has(i,"relatedModel")&&(a=i.relatedModel,o="model"),e.has(i,"collectionType")&&(a=i.collectionType,o="collection"),a&&("model"!==o||t.Models.has(a)?"collection"!==o||t.Collections.has(a)||t.Collections.set(a,t.Collections.Generic.extend({entity:a})):t.Models.set(a,t.Models.Generic.extend({entity:a})))},hydrateTypes:function(t,i,s){this.hydrateType(t,i,s),e.has(t,"reverseRelation")&&this.hydrateType(t.reverseRelation,i,s)},parse:function(s,n){if(!e.has(s,"payload"))return s;if(this._isHydrated=!0,void 0!==this.globals.get("entity")){"object"==typeof s.meta.relations&&e.each(s.meta.relations,this.hydrateRelations,i),t.Models.has(this.globals.get("entity"))||t.Models.set(this.globals.get("entity"),"object"==typeof s.meta.relations?t.Models.Generic.extend({relations:s.meta.relations}):t.Models.Generic.extend()),"object"==typeof s.meta.relations&&e.each(s.meta.relations,this.hydrateTypes,this);var a=function(t,i,s){e.has(i,s)&&t.set(s,i[s])};a(this.meta,s.meta,"editUrl"),a(this.meta,s.meta,"countCurrent"),a(this.meta,s.meta,"countTotal"),a(this.meta,s.meta,"pageCurrent"),a(this.meta,s.meta,"pageTotal"),a(this.meta,s.meta,"searchable"),this.model=t.Models.get(this.globals.get("entity"))}var o=e.first(s.meta.status);return"SUCCESS"!==o.code&&"NOTFOUND"!==o.code?(t.Events.trigger("toast",o.message,o.code,"danger"),t.Environment.get("production")||console.trace("Error:",s),this.trigger("error",this,s,n)):(t.Environment.get("production")||console.info("Success:",s),this.trigger("success",this,s,n)),s.payload},refresh:function(t){t=t&&"object"==typeof t?t:{},"string"==typeof this.url&&this.url.toLowerCase()!=="/Api".toLowerCase()?this.fetch(this.meta.has("api")?e.extend(t,{data:this.meta.get("api")}):t):this.models.length&&(this._isHydrated=!0,e.each(this.models,function(t){t._isHydrated=!0}),this.trigger("success",this,this.models,t),this.trigger("reset",this,t))},toJSON:function(t){var i=[];return this.each(function(t){var s=t.toJSON();i.push(e.has(s,"payload")?s.payload:s)}),this.meta.size()>0?{meta:this.meta.toJSON(),payload:e.clone(i)}:e.clone(i)},findParent:function(t,e,i){return void 0!==i&&t.get(e)&&t.get(e).get("id")===i?t:t.get(e)?this.findParent(t.get(e),e,i):t},findParents:function(t,e,i){return void 0===i&&(i=[]),t.has("id")&&i.push(t.get("id")),t.get(e)?this.findParents(t.get(e),e,i):i},compare:function(t,i,s,n,a){var o=null,r=!1,l=!1,h=null,d=null,c=null,u=null,y=null,f=null,g=!e.isUndefined(a)&&!e.isUndefined(t.get(a))&&!e.isUndefined(i.get(a));if(g&&(h=t.get(a),d=i.get(a)),h||e.isUndefined(t.get(s))||(h=t),d||e.isUndefined(i.get(s))||(d=i),(g=g&&h&&d)&&(c=!t.get(a),u=!i.get(a),e.isEqual(h.toObject(),d.toObject())?r=c||u:c||u||(c=e.isEqual(t.toObject(),i.get(a).toObject()),u=e.isEqual(i.toObject(),t.get(a).toObject()),r=c||u),!r&&(c||u||(l=e.isEqual(t.get(a).toObject(),i.get(a).toObject())),!l))){if(y=this.findParent(t,a),f=this.findParent(i,a),l=e.isEqual(y.toObject(),f.toObject())){var p=e.first(e.intersection(this.findParents(t,a),this.findParents(i,a))),m=this.findParent(t,a,p),b=this.findParent(i,a,p);e.isEqual(m.toObject(),f.toObject())||e.isEqual(y.toObject(),b.toObject())||(y=m,f=b)}h=y,d=f}return r?(h=c?1:0,d=u?1:0):(h=h?h.get(s):0,d=d?d.get(s):0),h>d?o=1:h<d&&(o=-1),o&&n?-o:o},comparator:function(t,e){var i=null;return i||(i=this.compare(t,e,"priority",!0,"parent")),i||(i=this.compare(t,e,"priority",!0)),i||(i=0),i},save:function(){console.warn("Saving collections is not fully implemented."),this.sync("update",this,{url:this.url})},saveOne:function(t){t.save()},saveAll:function(){this.models.each(this.saveOne,this)}})});