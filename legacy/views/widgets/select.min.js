!function(t,e){"function"==typeof define&&define.amd?define(["stratus","jquery","underscore","text!templates-widgets-select","stratus.views.widgets.base"],e):e(t.Stratus,t.$,t._)}(this,function(t,e,i,s){t.Views.Widgets.Select=t.Views.Widgets.Base.extend({model:t.Models.Generic,template:i.template(s||""),options:{private:{autoSave:!1,forceType:"model"},public:{editable:!0,multiple:!1,multipleSize:5,ui:null,placeholder:"Click to See Options",showPaginatorTop:!1,showSearch:!1,showSelected:!0,selectedTemplates:{combined:"templates-widgets-selected-options"},textSelectedHeader:"Selected Options",textSelectedNoContent:"No {{TYPE}} Selected",cssSelectedNoContent:"addAnimation",selectedRemove:!1,selectedDrag:!1,choices:null,source:null,sourceTarget:null,sourceApi:null,sourceIdAttribute:"id",sourceLabelAttribute:"id",sourceImageAttribute:"images",sourceTemplates:{combined:"templates-widgets-select-options"},sourceLimit:null,cssFile:[t.BaseUrl+t.BundlePath+"views/widgets/select.css",t.BaseUrl+"sitetheorycore/css/Core/list.css"],classDropdown:"pull-left"}},events:{"click .selectOptionsContainer .optionContainer input":"syncModel","change .selectOptionsContainer select":"syncModel","click .selectedOptionsContainer button.delete":"removeSelectedOption"},postOptions:function(t){"list"===this.options.ui?this.options.classDropdown="":(this.options.showSelected=!1,this.options.sourceLimit=100,null===this.options.ui?this.options.classDropdown="":this.options.classDropdown+=" dropdown-menu"),this.options.inputType=!0===this.options.multiple?"checkbox":"radio",this.options.inputName=this.uid+"_"+this.propertyName.replace(".","_"),this.options.source&&(this.options.sourceApi=i.extend(this.options.sourceApi||{},{limit:this.options.sourceLimit}),this.options.sourceMeta={ui:this.options.ui,inputType:this.options.inputType,inputName:this.options.inputName,placeholder:this.options.placeholder,modelIdAttribute:this.options.sourceIdAttribute,modelLabelAttribute:this.options.sourceLabelAttribute,modelImageAttribute:this.options.sourceImageAttribute},this.options.showSelected&&(this.options.selectedMeta={elementId:this.element,api:this.options.sourceApi,modelLabelAttribute:this.options.sourceLabelAttribute,modelImageAttribute:this.options.sourceImageAttribute}),this.options.textSelectedNoContent=this.options.textSelectedNoContent.replace("{{TYPE}}",i.ucfirst(this.options.source)))},onResolve:function(){i.isObject(this.options.sourceTarget)&&!i.isArray(this.options.sourceTarget)&&(this.options.sourceTarget=[this.options.sourceTarget]),i.isArray(this.options.sourceTarget)&&(this.options.collectionTarget=[],i.each(this.options.sourceTarget,function(t,e){!i.has(t,"id")&&i.has(t,"idAttribute")&&this.model.get(t.idAttribute)&&(t.id=this.model.get(t.idAttribute)),i.has(t,"entity")&&i.has(t,"id")&&this.options.collectionTarget.push({entity:t.entity,id:t.id})},this))},validate:function(){return this.$el.data("property")?!this.options.choices||"object"==typeof this.options.choices||(t.Events.trigger("toast","The data-choice attribute is defined as a JSON string, but it is not an array.","Incorrect Data Attribute Format","danger"),!1):(t.Events.trigger("toast","The data-property attribute is missing.","Missing Data Attribute","danger"),!1)},onRender:function(t){this.containerOptions=this.$el.find(".selectOptionsContainer"),this.containerPlaceholder="menu"===this.options.ui?this.$el.find(".placeholder"):null,this.containerSelected=this.options.showSelected?this.$el.find(".selectedOptionsContainer"):null,this.options.source&&t.parent.total&&i.each(t.parent.views,function(t){i.has(t,"collection")&&"object"==typeof t.collection&&(this.optionsCollection=t.collection)},this),this.options.showSelected&&t.nest.total&&i.each(t.nest.views,function(t){i.has(t,"collection")&&"object"==typeof t.collection&&(this.selectedCollection=t.collection)},this),this.addOptions(),this.options.showSelected},onRegister:function(){return"model"===this.options.dataType&&(this.getSelectedCollection(),this.model.on("change:"+this.propertyName,function(){this.model.once("success",function(){"menu"!==this.options.ui||this.options.showSelected||this.getSelectedCollection()},this)},this)),this.options.source&&this.dispatch.on("render",this.syncDom,this),!0},addOptions:function(t){if(!this.options.choices||!this.containerOptions)return!1;i.each(this.options.choices,function(t,e){var i=t,s=t,o=null,n=null,l="";"object"==typeof t&&(i=t.value?t.value:null,s=t.label?t.label:i,l=t.containerClass?" "+t.containerClass:"",void 0!==t.checked&&!0===t.checked&&(n="menu"===this.options.ui?'checked="checked"':'selected="selected"'),t.image&&(t.image,o='style="background-image:url('+t.image+');"',l+=" hasImage"));var c=this.options.inputName+"-selectOption-"+e;"menu"===this.options.ui?this.containerOptions.append('<div class="optionContainer'+l+'" '+o+'><input id="'+c+'" type="'+this.options.inputType+'" name="'+this.options.inputName+'" value="'+i+'" '+n+' class="form-control selectOption"><label class="control-label selectImage" for="'+c+'">'+s+"</label></div>"):this.containerOptions.append('<option value="'+i+'" '+n+">"+s+"</option>")},this),this.scopeChanged()},syncDom:function(){this.setInputValues(),this.containerPlaceholder&&this.setPlaceholder()},syncModel:function(t){var s=e(t.target).val();if(this.options.multiple){var o=this.getValue();e(t.target).is(":checked")?o.push(s):o=i.without(o,s),this.setPropertyValue(o)}else this.setPropertyValue(s);this.safeSaveAction()},removeSelectedOption:function(t){if(this.containerSelected){var s=e(t.currentTarget).dataAttr("value");if(s){var o=this.getPropertyValue();o&&"object"==typeof o&&(o=i.clone(o));var n=!1;i.isArray(o)||(o=[o],n=!0),i.each(o,function(t,e){i.isObject(t)&&i.has(t,"id")&&t.id===s?o.splice(e,1):t===s&&o.splice(e,1)});var l=n?i.first(o):o;this.setPropertyValue(l),this.setValue(l),this.safeSaveAction()}}},setInputValues:function(t){if(t=i.isArray(t)?t:this.getPropertyValues(),!this.containerOptions)return!1;this.options.ui?i.each(this.containerOptions.find("input"),function(s){e(s).prop("checked",i.contains(t,i.hydrate(e(s).val())))},this):i.each(this.containerOptions.find("option"),function(s){e(s).prop("selected",i.contains(t,i.hydrate(e(s).attr("value"))))},this)},getOptionLabel:function(t){if(!t)return!1;var e=[];return t="object"==typeof t&&i.isArray(t)?t:[t],this.options.choices?i.each(this.options.choices,function(s){var o=s,n=s;"object"==typeof s&&(o=void 0!==s.value?s.value:null,n=void 0!==s.label?s.label:o),i.contains(t,o)&&e.push({value:o,label:n})},this):this.options.source&&this.selectedCollection&&this.selectedCollection.models.length>0&&this.selectedCollection.forEach(function(s){var o=s.get(this.options.sourceIdAttribute),n=s.get(this.options.sourceLabelAttribute);i.contains(t,o)&&e.push({value:o,label:n})},this),e},setPlaceholder:function(){var t=this.getOptionLabel(this.getPropertyValue());if(t.length>0){var e=i.first(t).label;t.length>1&&(e+=" (+"+(t.length-1)+" more)"),this.containerPlaceholder.text(e)}},getSelectedCollection:function(){if(!this.options.source)return!1;void 0===this.selectedCollection?(this.selectedCollection=new t.Collections.Generic({entity:i.ucfirst(this.options.source),target:this.modelTarget(),initialize:!0,api:{property:this.propertyName}}),t.Instances[this.selectedCollection.globals.get("uid")]=this.selectedCollection,"string"==typeof this.propertyName&&this.model.on("change:"+this.propertyName,function(){this.model.once("success",function(){this.model.once("change",function(){this.selectedCollection.target=this.modelTarget(),this.selectedCollection.refresh({reset:!0})},this)},this)},this),this.selectedCollection.on("reset",this.syncDom,this)):this.selectedCollection.refresh({reset:!0})},modelTarget:function(){var t={entity:this.model.entity,id:"id"};return"string"==typeof this.propertyName&&-1!==this.propertyName.indexOf(".")&&(t.entity=i.first(this.propertyName.split(".")),this.model.has(t.entity+".id")?t.id=t.entity+".id":t.entity=this.model.entity),{entity:i.ucfirst(t.entity),id:this.model.get(t.id)}},scopeChanged:function(){return this.setValue(this.getPropertyValues()),this.options.choices&&this.syncDom(),!0},setValue:function(t){if(void 0===t)return!1;this.options.multiple&&!i.isArray(t)&&(t=null===t?[]:[t]),this.$el.dataAttr("value",t)},getValue:function(){var t=this.$el.dataAttr("value");return!1===this.options.multiple&&i.isArray(t)?i.first(t):t}})});