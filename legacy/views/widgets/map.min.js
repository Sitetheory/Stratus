!function(t,o){"function"==typeof define&&define.amd?define(["stratus","jquery","underscore","stratus.views.widgets.base"],o):o(t.Stratus,t.$,t._)}(this,function(t,o,i){t.Views.Widgets.Map=t.Views.Widgets.Base.extend({model:t.Models.Generic,templates:{infoWindow:i.template("<div>{% if (location.title) { %}<h3>{{ location.title }}</h3>{% } %}{% if (location.details) { %}<p>{{ location.details }}</p>{% } %}</div>")},currentLocation:null,map:null,markers:[],infoWindows:[],options:{private:{locationSample:{position:{lat:37.8288771,lng:-122.1591649},center:!1,template:"template name set in templates (optional)",title:"Marker Name",details:"The first template assumes a details variable can exist"}},public:{template:"sitetheorymap/stratus/templates/map.infoWindow.html",apiKey:t.Api.GoogleMaps,tile:256,fitBounds:!0,centerOnUser:!1,autoLabel:!1,labelOptions:{numericStart:1,alphaStart:"A"},zoom:13,center:{lat:37.8988771,lng:-122.0591649},locations:[]}},prepareOptions:function(){this.options.center instanceof google.maps.LatLng||void 0===this.options.center.lat||void 0===this.options.center.lng||(this.options.center=new google.maps.LatLng(this.options.center)),void 0!==this.options.locations&&this.options.locations instanceof Object&&(this.options.locations instanceof Array||(this.options.locations=[this.options.locations]),i.each(this.options.locations,function(t){null!=t.position&&(t.position=this.prepareLatLng(t.position)),t.center&&null!=t.position&&(this.options.center=t.position),"string"==typeof t.template&&this.templates[t.template]?t.template=this.templates[t.template]:null!=this.templates&&this.templates[Object.keys(this.templates)[0]]?t.template=this.templates[Object.keys(this.templates)[0]]:"function"!=typeof t.template&&(console.warn("no template for location",t),delete t.template)},this))},prepareLatLng:function(t){return t instanceof google.maps.LatLng||void 0===t?t:new google.maps.LatLng(t)},onRender:function(t){require(["//maps.googleapis.com/maps/api/js?key="+this.options.apiKey],function(){this.prepareOptions(),console.log("!!MAP OPTIONS",this.options),console.warn(this.collection.toJSON().payload),this.setupMarkersLayout()}.bind(this))},fetchCurrentLocation:function(){return new Promise(function(o,i){t.Internals.Location().then(function(t){this.currentLocation=new google.maps.LatLng(t.coords.latitude,t.coords.longitude),o&&o(this.currentLocation)}.bind(this),function(t){i&&i(t)}.bind(this))})},setupMarkersLayout:function(){this.renderMap();var t=new google.maps.LatLngBounds,o=this.options.labelOptions.numericStart,n=this.options.labelOptions.alphaStart.charCodeAt(0);i.each(this.options.locations,function(i){if(!i||!i.position||"function"!=typeof i.template)return!1;var e=this.addInfoWindow({content:i.template({location:i})}),s={position:i.position};s.animation=google.maps.Animation.DROP,"numeric"==this.options.autoLabel?s.label=""+o++:"alpha"==this.options.autoLabel&&(s.label=String.fromCharCode(n++));var a=this.addMarker(s);t.extend(i.position),a.addListener("click",function(){e.open(this.map,a)}.bind(this))},this),this.options.fitBounds&&this.map.fitBounds(t),this.options.centerOnUser&&this.fetchCurrentLocation().then(function(t){this.options.center=t,this.map.setCenter(this.options.center)}.bind(this),function(t){console.warn("Can't get currentLocation",t),this.currentLocation&&(this.options.center=this.currentLocation,this.map.setCenter(this.options.center))}.bind(this))},renderMap:function(t,o){return!this.map&&(this.map=new google.maps.Map(this.$el[0],{center:(t||{}).center||this.options.center,zoom:(t||{}).zoom||this.options.zoom}),o&&o(this.map),!0)},addMarker:function(t){if(!t)return!1;if(!t.position)return!1;if(!this.map)return!1;t.map=this.map;var o=new google.maps.Marker(t);return this.markers.push(o),o},addInfoWindow:function(t){if(!t)return!1;var o=new google.maps.InfoWindow(t);return this.infoWindows.push(o),o},projectCoord:function(t){var o=Math.sin(t.lat()*Math.PI/180);return o=Math.min(Math.max(o,-.9999),.9999),new google.maps.Point(this.options.tile*(.5+t.lng()/360),this.options.tile*(.5-Math.log((1+o)/(1-o))/(4*Math.PI)))},sampleContent:function(){var t=1<<(this.map?this.map.getZoom():this.options.zoom),o=this.projectCoord(this.currentLocation||this.options.center),i=new google.maps.Point(Math.floor(o.x*t),Math.floor(o.y*t)),n=new google.maps.Point(Math.floor(o.x*t/this.options.tile),Math.floor(o.y*t/this.options.tile)),e=[];return this.currentLocation?e.push("Lat/Lng: "+this.currentLocation):e.push("Can't Get Current Location ","Center: "+this.options.center),e.push("Zoom level: "+(this.map?this.map.getZoom():this.options.zoom),"World Coordinate: "+o,"Pixel Coordinate: "+i,"Tile Coordinate: "+n),e.join("<br>")}})});