!function(t,e){"function"==typeof define&&define.amd?define(["stratus","jquery","underscore","masonry","sortable","stratus.views.widgets.base","stratus.views.widgets.generic"],e):e(t.Stratus,t.$,t._,t.Masonry,t.Sortable)}(this,function(t,e,i,o,s){t.Views.Widgets.Collection=t.Views.Widgets.Base.extend({template:i.template('<div data-collection="{{ globals.uid }}" data-entity="{{ globals.entity }}" data-id="{{ model.id }}"></div>'),errorTemplate:i.template('{% if (collection.meta.has("api.q")) { %}<div class="{{ options.cssNoResults}}"><div class="message">{{ options.textNoResults }}</div><div class="icon"></div></div>{% } else if (typeof code === "string") { %}<div class="{{ options.cssError}}"><div class="message">An Internal Error (Code: {{ code }}) occurred.  Please notify support with the url and time of the error.</div><div class="icon"></div></div>{% } else { %}<div class="{{ options.cssNoContent }}"><div class="message">{{ options.textNoContent }}</div><div class="icon"></div></div>{% } %}'),events:{"keypress #newGeneric":"createOnEnter",start:"dragStart",end:"dragEnd"},templateRender:"container",options:{private:{api:{limit:null},autoLoader:!1},public:{source:null,limit:null,batch:null,phantoms:null,width:null,height:null,meta:null,success:null,error:null,add:null,change:null,destroy:null,rerender:null,resync:null,masonry:null,sortable:null,standalone:!1,textNoResults:"We were unable to find any content matching your request.",cssNoResults:"empty",textNoContent:"No content available.",cssError:"error",cssNoContent:"empty",truncate:250}},handled:!1,promise:function(t,e,o){if(i.has(this.options,"rerender")){var s=i.isArray(this.options.rerender)||i.isObject(this.options.rerender)?i.clone(this.options.rerender):null,n=s?"none":this.options.rerender;i.each(["success","error","add","change","destroy"],function(t){this.options[t]=n},this),s&&i.each(s,function(t,e){t&&(i.isObject(t)?i.each(t,function(t,e){this.options[e]=t},this):i.isString(e)?this.options[e]=t:this.options[t]="all")},this),"none"===this.options.rerender&&(this.options.success="none",this.options.error="none",this.options.add="none",this.options.change="none",this.options.destroy="none")}this.collection&&"object"==typeof this.collection?this.handleCollection():this.model&&"object"==typeof this.model&&this.handleProperty(),this.views={},this.once("render",function(t){e(t)})},postOptions:function(t){this.options.limit&&(this.options.api.limit=this.options.limit)},primeAdd:function(t,e){this.options.add&&"all"!==this.options.add?"one"===this.options.add||"none"===this.options.add?this.collection.size()>1?(this.buildGlobals(t),this.addOne(t)):this.addAll():console.warn("Add Event contains unknown option:",this.options.add):this.addAll()},primeReset:function(t,e){this.addAll()},primeSuccess:function(e,i){this.options.success&&"all"!==this.options.success?(e instanceof t.Collections.Generic&&"collection"===this.options.success||e instanceof t.Models.Generic&&"model"===this.options.success)&&this.addAll():this.addAll()},primeError:function(t,e){},primeChange:function(t,e){this.options.change&&"all"!==this.options.change&&(!i.has(e,"xhr")||this.options.success&&"all"!==this.options.success)||this.addAll()},primeDestroy:function(t,e,i){this.options.destroy||this.addAll()},modelTarget:function(){var t={entity:this.model.entity,id:"id"};return"string"==typeof this.propertyName&&-1!==this.propertyName.indexOf(".")&&(t.entity=i.first(this.propertyName.split(".")),this.model.has(t.entity+".id")?t.id=t.entity+".id":t.entity=this.model.entity),{entity:i.ucfirst(t.entity),id:this.model.get(t.id)}},handleProperty:function(){var e=this.model.get(this.propertyName);i.isArray(e)?(this.collection=new t.Collections.Generic({initialize:!0}),this.collection.set(e)):this.collection=new t.Collections.Generic({entity:i.ucfirst(this.options.source),target:this.modelTarget(),initialize:!0,api:{property:this.propertyName}}),t.Instances[this.collection.globals.get("uid")]=this.collection,"string"==typeof this.propertyName&&this.model.on("change:"+this.propertyName,function(){this.model.once("success",function(){this.model.once("change",function(){this.collection.target=this.modelTarget(),this.collection.refresh({reset:!0})},this)},this)},this),this.handleCollection()},handleCollection:function(){if(this.handled)return!1;this.handled=!0,this.collection.on("reset",this.primeReset,this),this.collection.on("success",this.primeSuccess,this),this.collection.on("error",this.primeError,this),this.collection.on("add",this.primeAdd,this),this.collection.on("change",this.primeChange,this),this.collection.on("destroy",this.primeDestroy,this)},clearGlobals:function(t){i.each(this.collection.globals.get("levels"),function(t,e,i){this.collection.globals.set("level"+t,0),this.collection.globals.set("total"+t,0)},this),i.each(this.collection.globals.get("parents"),function(t,e,i){this.collection.globals.set("parent"+t,0),this.collection.globals.set("parentTotal"+t,0)},this)},buildGlobals:function(e){var i=e.has("level")?e.get("level"):1;this.collection.globals.iterate("total"+i),e.has("parent")&&null!==t.Relations.Sanitize(e,"parent","id")&&this.collection.globals.iterate("parentTotal"+t.Relations.Sanitize(e,"parent","id"))},drag:function(){},onError:function(t,e,o){return i.has(e,"status")&&200!==e.status&&this.$el.html(this.errorTemplate({collection:this.collection,options:this.options,code:e.status.toString()})),!0},addOne:function(o){var n=o.has("parent")&&null!==t.Relations.Sanitize(o,"parent","id"),l=0,a={parent:n?t.Relations.Sanitize(o,"parent","id"):0,child:n,level:o.has("level")?o.get("level"):1,iteration:0,total:0,phantom:!1,last:!1,entity:this.collection.globals.get("entity"),meta:this.options.meta,hook:this.el,uid:this.collection.globals.get("uid"),weight:0,gravity:0,compound:0,options:this.options};if(a.iteration=this.collection.globals.iterate("level"+a.level),a.total=this.collection.globals.get("total"+a.level),a.last=a.iteration===a.total,i.has(this.templates,"combined")||i.has(this.templates,"list")){var c=this.$el.find('[data-hook="containers"]');c.length>0&&(a.hook=c)}if(this.options.batch){var r=a.iteration%this.options.batch;1===r?(a.iteration=1,this.collection.globals.set("batchParent",o.get("id")),this.collection.globals.set("parent"+o.get("id"),1)):(a.parent=this.collection.globals.get("batchParent"),a.child=!0),0===r&&(a.last=!0),0!==r&&a.last&&(l=this.options.batch-r,a.last=!1)}if(this.collection.globals.add("levels",a.level),this.collection.globals.add("parents",a.parent),a.child){a.iteration=this.collection.globals.iterate("parent"+a.parent),a.total=this.collection.globals.get("parentTotal"+a.parent),a.last=a.iteration===a.total;var h='[data-collection="'+a.uid+'"]';a.entity&&(h+='[data-entity="'+a.entity+'"]'),h+='[data-hook="parent'+a.parent+'"]',e(h).length>0&&(a.hook=h)}a.weight=1/a.total,a.gravity=a.weight*a.iteration,a.compound=1/(a.total-1)*(a.iteration-1),e(a.hook).append(this.template({scope:"container",globals:a,meta:this.collection.meta.toObject(),model:o.attributes})),this.collection.globals.iterate("modelNumber");var d=o.has("id")?o.get("id"):this.collection.globals.get("modelNumber");i.has(this.views,d)&&this.views[d].onDestroy();var p=new t.Internals.View(i.extend({},this.view.nest(),{uid:a.uid,id:o.get("id"),scope:"model",model:o,collection:this.collection})),u=i.extend({},p.toObject(),{uid:i.uniqueId("generic_"),collectionView:this,globals:a,templates:this.templates,type:"generic",rerender:{change:this.options.change},view:p,style:this.options.style});if(this.views[d]=t.Instances[u.uid]=new t.Views.Widgets.Generic(u),a.child&&a.last&&s.create(i.first(e(a.hook)),{draggable:".draggable",group:this.entity}),l&&i.has(this.templates,"entity")){var g=i.clone(a);g.iteration=this.options.batch-g.iteration,g.model=null,g.phantom=!0,g.parent=this.collection.globals.get("batchParent"),g.child=!0,g.hook='[data-collection="'+a.uid+'"][data-entity="'+g.entity+'"][data-hook="parent'+g.parent+'"]';for(var m=this.templates.combined||this.templates.entity,f=0;f<l;f++)g.iteration++,f===l-1&&(g.last=!0),e(g.hook).append(m({scope:"entity",globals:g}))}this.collection.globals.get("lastLevel")>a.level&&this.collection.globals.set("level"+this.collection.globals.get("lastLevel"),0),this.collection.globals.set("lastLevel",a.level)},addAll:function(){var e={scope:"list",collection:this.collection,options:this.options};this.$el.html(i.has(this.templates,"combined")?this.templates.combined(e):i.has(this.templates,"list")?this.templates.list(e):""),this.$el.html()&&this.$el.html().trim().length||this.collection.size()||this.$el.html(this.errorTemplate({collection:this.collection,options:this.options})),this.$el.html()&&this.$el.html().trim().length&&t.Internals.Loader(this.el||this.$el,this.view).then(function(e){t.Internals.Loader(this.$el.find("[data-entity]")).then(function(t){})}.bind(this),function(t){console.error("List Views:",t)}),this.options.autosort&&this.collection.sort(),this.clearGlobals(),this.collection.models.forEach(this.buildGlobals,this),this.collection.models.forEach(this.addOne,this),this.options.masonry&&new o(this.el,{itemSelector:".grid-item",columnWidth:160,percentPosition:!0}),this.options.sortable&&s.create(this.el,{group:this.entity}),this.trigger("render",this)},dragStart:function(t){},dragEnd:function(o){var s=e(o.originalEvent.item),n={el:s=s.dataAttr("id")?s:s.find("[data-id]"),id:s.data("id"),entity:s.data("entity"),priority:i.size(this.collection.models)-o.originalEvent.newIndex,reference:t.Models.Generic};n.entity&&n.id&&(n.reference=t.Models.get(n.entity).findOrCreate(n.id),n.reference.once("success",function(t,e){this.collection.refresh({reset:!0})},this),n.reference.save("priority",n.priority))}})});