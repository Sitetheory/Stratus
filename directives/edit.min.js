!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.model"],factory):factory(root.Stratus,root._)}(this,function(Stratus,_){Stratus.Directives.Edit=function($parse,$log,model){return{restrict:"A",require:"ngModel",scope:{ngModel:"=",property:"@",emptyValue:"@",stratusEdit:"=",alwaysEdit:"@",autoSave:"@"},link:function($scope,$element,$attrs,ngModel){return $scope.uid=this.uid=_.uniqueId("edit_"),Stratus.Instances[this.uid]=$scope,$scope.model=null,$scope.value=null,ngModel&&$scope.property?(ngModel.$render=function(){$element.html($scope.value||$scope.emptyValue||"")},$scope.liveEditStatus=function(){return void 0!==$scope.stratusEdit?$scope.stratusEdit:void 0!==Stratus.Environment.data.liveEdit?Stratus.Environment.data.liveEdit:(console.warn($scope.uid+" has no variable to track edit toggle! ($scope.stratusEdit)"),!1)},$scope.read=function(){$scope.value=$element.html()},$scope.accept=function(){$scope.model instanceof model&&$scope.property&&($scope.model.set($scope.property,$scope.value),$scope.model.save())},$scope.cancel=function(){$scope.model instanceof model&&$scope.property&&($scope.value=$scope.model.get($scope.property))},$scope.alwaysEdit!==!0&&"true"!==$scope.alwaysEdit?$scope.$watch($scope.liveEditStatus,function(liveEdit){$element.attr("contenteditable",liveEdit),liveEdit?$element.addClass("liveEdit"):$element.removeClass("liveEdit")}):$element.attr("contenteditable",!0),$scope.$watch("ngModel",function(data){data instanceof model&&!_.isEqual(data,$scope.model)&&($scope.model=data)}),$scope.$watch("model.data."+$scope.property,function(data){$scope.value=data,ngModel.$render()}),$element.on("focusout keyup change",function(){if($scope.$apply($scope.read),$scope.autoSave!==!1&&"false"!==$scope.autoSave)switch(event.type){case"focusout":case"blur":$scope.$apply($scope.accept)}}),void $element.on("keydown keypress",function(event){switch(event.which){case Stratus.Key.Enter:event.preventDefault(),$scope.autoSave!==!1&&"false"!==$scope.autoSave&&$scope.$apply($scope.accept);break;case Stratus.Key.Escape:$scope.$apply($scope.cancel)}})):void console.warn($scope.uid+" has no model or property!")}}}});