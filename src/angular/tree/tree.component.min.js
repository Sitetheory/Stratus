System.register(["@angular/core","@angular/forms","@angular/cdk/drag-drop","@angular/cdk/tree","@angular/material/dialog","@angular/platform-browser","@angular/material/icon","rxjs","rxjs/operators","stratus","lodash","@stratus/angular/backend.service"],function(t,e){"use strict";var n,i,a,r,s,o,l,c,d,h,u,p,f,g,m,y=this&&this.__decorate||function(t,e,n,i){var a,r=arguments.length,s=r<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,i);else for(var o=t.length-1;o>=0;o--)(a=t[o])&&(s=(r<3?a(s):r>3?a(e,n,s):a(e,n))||s);return r>3&&s&&Object.defineProperty(e,n,s),s},C=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},b=this&&this.__param||function(t,e){return function(n,i){e(n,i,t)}},D=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(a,r){function s(t){try{l(i.next(t))}catch(t){r(t)}}function o(t){try{l(i.throw(t))}catch(t){r(t)}}function l(t){t.done?a(t.value):new n(function(e){e(t.value)}).then(s,o)}l((i=i.apply(t,e||[])).next())})};e&&e.id;return{setters:[function(t){n=t},function(t){i=t},function(t){a=t},function(t){r=t},function(t){s=t},function(t){o=t},function(t){l=t},function(t){c=t},function(t){d=t},function(t){h=t},function(t){u=t},function(t){p=t}],execute:function(){f="/assets/1/0/bundles/sitetheorystratus/stratus/src/angular","@stratus/angular","tree",g=class{constructor(t,e,n,i){this.dialogRef=t,this.data=e,this.fb=n,this.backend=i,this.isContentLoading=!1}ngOnInit(){this.dialogContentForm=this.fb.group({contentSelectorInput:this.data.content}),this.dialogContentForm.get("contentSelectorInput").valueChanges.pipe(d.debounceTime(300),d.tap(()=>this.isContentLoading=!0),d.switchMap(t=>(u.isString(t)?this.lastContentSelectorQuery=`/Api/Content?q=${t}`:(this.data.content=t,this.data.url=null),this.backend.get(this.lastContentSelectorQuery).pipe(d.finalize(()=>this.isContentLoading=!1))))).subscribe(t=>{if(!t.ok||200!==t.status||u.isEmpty(t.body))return this.filteredContentOptions=[];const e=u.get(t.body,"payload")||t.body;return u.isEmpty(e)||!Array.isArray(e)?this.filteredContentOptions=[]:this.filteredContentOptions=e})}onCancelClick(){this.dialogRef.close()}displayVersionTitle(t){if(t)return u.get(t,"version.title")}},g=y([n.Component({selector:"sa-tree-dialog",templateUrl:`${f}/tree/tree.dialog.html`,changeDetection:n.ChangeDetectionStrategy.OnPush}),b(1,n.Inject(s.MAT_DIALOG_DATA)),C("design:paramtypes",[s.MatDialogRef,Object,i.FormBuilder,p.BackendService])],g),t("TreeDialogComponent",g),m=class{constructor(t,e,n,a){this.iconRegistry=t,this.sanitizer=e,this.dialog=n,this.ref=a,this.title="tree-dnd",this.selectCtrl=new i.FormControl,this.registry=new h.Data.Registry,this.onChange=new c.Subject,this.dropListIds=[],this.dropListIdMap={},this.treeControl=new r.NestedTreeControl(t=>t.children||[]),this.hasChild=(t,e)=>e.children&&e.children.length>0,this.uid=u.uniqueId("sa_tree_component_"),h.Instances[this.uid]=this,this._=u,t.addSvgIcon("delete",e.bypassSecurityTrustResourceUrl("/Api/Resource?path=@SitetheoryCoreBundle:images/icons/actionButtons/delete.svg")),h.Internals.CssLoader(`${f}/tree/tree.component.css`),this.fetchData().then(t=>{t.on?(t.on("change",()=>{t.completed&&a.detectChanges()}),a.detectChanges()):console.warn("Unable to bind data from Registry!")}),this.dataSub=new c.Observable(t=>this.dataDefer(t)),this.dropListIdMap[`${this.uid}_drop_list`]=!0,this.createDropListIds()}remove(t){const e=this.dataRef();if(!e||!e.length)return;const n=e.indexOf(t);-1!==n&&(e.splice(n,1),this.model.trigger("change"))}fetchData(){return D(this,void 0,void 0,function*(){return this.fetched||(this.fetched=this.registry.fetch(h.Select("#content-menu-primary"),this)),this.fetched})}dataDefer(t){this.subscriber=t;const e=this.dataRef();e&&e.length?t.next(e):setTimeout(()=>this.dataDefer(t),200)}dataRef(){if(!this.collection)return[];const t=this.collection.models;if(!t||!u.isArray(t))return[];this.treeMap={};const e=this,n=[];return u.each(t,t=>{const i=u.get(t,"data.id"),a=u.get(t,"data.nestParent.id");e.dropListIdMap[`${e.uid}_${i}_drop_list`]=!0,u.has(e.treeMap,i)||(e.treeMap[i]={model:null,children:[]}),e.treeMap[i].model=t,a?(u.has(e.treeMap,a)||(e.treeMap[a]={model:null,children:[]}),e.treeMap[a].children.push(e.treeMap[i])):n.push(e.treeMap[i])}),this.createDropListIds(),n}createDropListIds(){this.dropListIds=u.keys(this.dropListIdMap)}onDataChange(t){this.dataDefer(this.subscriber),t.detectChanges()}onDragDrop(t){const e=this.dataRef();if(e&&e.length){if(console.log("container.data:",t.container.data),t.container.element.nativeElement.classList.remove("active"),this.canBeDropped(t)){t.item.data}else a.moveItemInArray((t.container.data?t.container.data.children:[])||[],t.previousIndex,t.currentIndex);console.log(`model drop: ${t.item.data.model.get("name")}`,`list shift: ${t.container.element.nativeElement.id} -> ${t.previousContainer.element.nativeElement.id}`,`index change: ${t.previousIndex} -> ${t.currentIndex}`)}}canBeDropped(t){const e=t.item.data;return t.previousContainer.id!==t.container.id&&this.isNotSelfDrop(t)&&!this.hasChild(e,t.item.data)}isNotSelfDrop(t){return console.log("isNotSelfDrop",t.item.data,t.item.data),!u.isEqual(t.item.data,t.item.data)}openDialog(t){if(!t||!u.has(t,"data"))return;const e=this.dialog.open(g,{width:"250px",data:{id:t.data.id||null,name:t.data.name||"",target:t.data.url?"url":"content",level:null===t.data.nestParent?"top":"child",content:t.data.content||null,url:t.data.url||null,priority:t.data.priority||0,model:t||null,collection:this.collection||null,parent:t.data.parent||null,nestParent:t.data.nestParent||null}});this.ref.detectChanges(),e.afterClosed().subscribe(e=>{e&&!u.isEmpty(e)&&(e.level&&"top"===e.level&&(e.nestParent=null),["name","content","url","priority","nestParent"].forEach(n=>{if(u.has(e,n))if("content"!==n)t.set(n,u.get(e,n));else{const i=u.get(e,n);t.set(n,i?{id:u.get(i,"id")}:null)}}),t.save())})}},m=y([n.Component({selector:"sa-tree",templateUrl:`${f}/tree/tree.component.html`,changeDetection:n.ChangeDetectionStrategy.OnPush}),C("design:paramtypes",[l.MatIconRegistry,o.DomSanitizer,s.MatDialog,n.ChangeDetectorRef])],m),t("TreeComponent",m)}}});