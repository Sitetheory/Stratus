(function(root,factory){if(typeof define==="function"&&define.amd){define(["stratus","underscore","jquery","moment","angular","stratus.components.calendar.timezones","fullcalendar","@fullcalendar/core","@fullcalendar/daygrid","angular-material","moment-range","stratus.services.iCal"],factory)}else{factory(root.Stratus,root._,root.jQuery,root.moment,root.angular)}})(this,function(Stratus,_,jQuery,moment,angular,timezones,fullcalendar,fullcalendarCore,fullcalendarDayGrid){const min=Stratus.Environment.get("production")?".min":"";const name="calendar";const localPath="extras/components";console.log("old fullcalendar",fullcalendar);console.log("new fullcalendar",fullcalendarCore);console.log("new fullcalendarDayGrid",fullcalendarDayGrid);Stratus.Components.Calendar={transclude:true,bindings:{elementId:"@",options:"@"},controller:function($scope,$attrs,$element,$sce,$mdPanel,$mdDialog,iCal){const $ctrl=this;$ctrl.uid=_.uniqueId(_.camelToSnake(name)+"_");Stratus.Instances[$ctrl.uid]=$scope;$scope.elementId=$attrs.elementId||$ctrl.uid;Stratus.Internals.CssLoader(Stratus.BaseUrl+Stratus.BundlePath+localPath+"/"+name+min+".css");$scope.initialized=false;$scope.calendarId=$scope.elementId+"_fullcalendar";$scope.calendar=null;$scope.calendarEl=null;Stratus.Internals.CssLoader(Stratus.BaseUrl+Stratus.BundlePath+"bower_components/fullcalendar-core/main"+min+".css");Stratus.Internals.CssLoader(Stratus.BaseUrl+Stratus.BundlePath+"bower_components/fullcalendar-daygrid/main"+min+".css");$scope.options=$attrs.options&&_.isJSON($attrs.options)?JSON.parse($attrs.options):{};$scope.options.customButtons=$scope.options.customButtons||null;$scope.options.buttonIcons=$scope.options.buttonIcons||{prev:"left-single-arrow",next:"right-single-arrow",prevYear:"left-double-arrow",nextYear:"right-double-arrow"};const defaultButtonText={today:"today",month:"month",listMonth:"month list",agendaWeek:"week agenda",basicWeek:"week",listWeek:"week list",agendaDay:"day agenda",basicDay:"day",listDay:"day list",listYear:"year"};$scope.options.buttonText=_.extend({},defaultButtonText,$scope.options.buttonText);$scope.options.defaultView=$scope.options.defaultView||"month";$scope.options.possibleViews=$scope.options.possibleViews||["month","weekAgenda","dayAgenda"];$scope.options.defaultDate=$scope.options.defaultDate||null;$scope.options.nowIndicator=$scope.options.nowIndicator||false;$scope.options.timezone=$scope.options.timezone||false;$scope.options.eventForceAllDay=$scope.options.eventForceAllDay||false;$scope.options.eventLimit=$scope.options.eventLimit||7;$scope.options.eventLimitClick=$scope.options.eventLimitClick||"popover";$scope.options.fixedWeekCount=$scope.options.fixedWeekCount||false;$scope.options.firstDay=$scope.options.firstDay||0;$scope.options.weekends=$scope.options.weekends||true;$scope.options.hiddenDays=$scope.options.hiddenDays||[];$scope.options.weekNumbers=$scope.options.weekNumbers||false;$scope.options.weekNumberCalculation=$scope.options.weekNumberCalculation||"local";$scope.options.businessHours=$scope.options.businessHours||false;$scope.options.RTL=$scope.options.RTL||false;$scope.options.height=$scope.options.height||null;$scope.options.contentHeight=$scope.options.contentHeight||null;$scope.options.aspectRatio=$scope.options.aspectRatio||1.35;$scope.options.handleWindowResize=$scope.options.handleWindowResize||true;$scope.options.windowResizeDelay=$scope.options.windowResizeDelay||100;$scope.options.eventSources=$scope.options.eventSources||[];$scope.initialized=false;$scope.fetched=false;$scope.startRange=moment();$scope.endRange=moment();$ctrl.$onInit=function(){iCal.registerTimezones(timezones);$ctrl.prepareHeader();setTimeout(async function(){try{if(!Stratus.Environment.get("production")){console.log("loading external urls:",$scope.options.eventSources)}await $ctrl.render();await Promise.all($scope.options.eventSources.map(url=>$scope.addEventICSSource(url)));if(!Stratus.Environment.get("production")){console.log("completed loading events:",arguments)}$scope.initialized=true}catch(e){console.error("calendar render:",e)}},1)};$scope.addEventICSSource=async function(url){let fullUrl=url;if(fullUrl.startsWith("http")){fullUrl=`https://cors-anywhere.herokuapp.com/${url}`}let response=await jQuery.get(fullUrl);if(!Stratus.Environment.get("production")){console.log("fetched the events from:",url)}const iCalExpander=new iCal.ICalExpander(response,{maxIterations:0});const events=iCalExpander.jsonEventsForFullCalendar(new Date("2018-01-24T00:00:00.000Z"),new Date("2020-01-26T00:00:00.000Z"));$scope.calendar.addEventSource({events:events});return events};$scope.handleEventClick=async function(clickEvent){console.log("Event",clickEvent);$scope.displayEventDialog(clickEvent.event,clickEvent.jsEvent);return false};$scope.displayEventDialog=async function(calEvent,clickEvent){return $mdDialog.show({templateUrl:Stratus.BaseUrl+"sitetheorystratus/stratus/extras/components/calendar.eventDialog"+min+".html",parent:angular.element(document.body),targetEvent:clickEvent,clickOutsideToClose:true,escapeToClose:false,fullscreen:true,locals:{eventData:calEvent},bindToController:true,controllerAs:"ctrl",controller:function($scope,$mdDialog){let dc=this;dc.$onInit=function(){if(dc.eventData&&dc.eventData.constructor.prototype.hasOwnProperty("extendedProps")){_.extend(dc.eventData,dc.eventData.extendedProps)}if(dc.eventData&&dc.eventData.hasOwnProperty("description")){dc.eventData.descriptionHTML=$sce.trustAsHtml(dc.eventData.description)}dc.close=close};function close(){if($mdDialog){$mdDialog.hide()}}}})};$ctrl.prepareHeader=function(){if($scope.options.header){return}let headerLeft="prev,next today";let headerCenter="title";let headerRight="month,agendaWeek,agendaDay";if(_.isArray($scope.options.possibleViews)){headerRight=$scope.options.possibleViews.join(",")}$scope.options.header={left:headerLeft,center:headerCenter,right:headerRight}};$ctrl.render=function(){$scope.calendarEl=document.getElementById($scope.calendarId);$scope.calendar=new fullcalendarCore.Calendar($scope.calendarEl,{eventClick:$scope.handleEventClick,plugins:[fullcalendarDayGrid.default]});console.log("loaded",$scope.calendar);$scope.calendar.render();return $scope.calendar}},template:'<div id="{{ elementId }}">'+'<div id="{{ calendarId }}"></div>'+"</div>"}});