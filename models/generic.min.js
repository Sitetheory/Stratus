//     Stratus.Models.Generic.js 1.0
//     Copyright (c) 2016 by Sitetheory, All Rights Reserved
//
//     All information contained herein is, and remains the
//     property of Sitetheory and its suppliers, if any.
//     The intellectual and technical concepts contained herein
//     are proprietary to Sitetheory and its suppliers and may be
//     covered by U.S. and Foreign Patents, patents in process,
//     and are protected by trade secret or copyright law.
//     Dissemination of this information or reproduction of this
//     material is strictly forbidden unless prior written
//     permission is obtained from Sitetheory.
//
//     For full details and documentation:
//     http://docs.sitetheory.io
!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","backbone","jquery"],e):e(t.Stratus,t._,t.Backbone,t.$)}(this,function(t,e,i,s){t.Models.Generic=i.RelationalModel.extend({meta:t.Prototypes.Collection,_isVersioned:!1,_autoSave:!1,autoSaveInterval:"1.5s",saveJob:null,initialized:!1,registered:!1,_isEvaluated:!1,_isHydrated:!1,_saving:!1,initialize:function(i,s){return this.meta=new t.Prototypes.Collection,e.has(this,"collection")&&e.has(this.collection,"api")&&this.collection.api&&this.meta.set(this.collection.api),this.primeRegister(),!0},primeRegister:function(){return this.registered=this.registered||this.onRegister(),!0},onRegister:function(){return this.on("change",this.primeEvaluation,this),this.on("save",this.onSave,this),this.on("refresh",this.refresh,this),this.saveJob=t.Chronos.add(1.5,this.saveInterval,this),!0},saveInterval:function(){return this._saving||this._changing||!this.isHydrated()||this.isNew()||!e.size(this.patch)||this.trigger("save",this.patch),!0},onSave:function(t){return this._saving=!0,this.save()},primeEvaluation:function(){return this._isEvaluated=this._isEvaluated||this.evaluate(),this._isEvaluated},evaluate:function(){return!!this.isHydrated()&&(this.patch={},!0)},safeInitialize:function(t){return!!this.initialized||(this.initialized=!0,this.entity=t.entity,this.target=t.target,this.versionEntity=t.versionEntity,this.versionRouter=t.versionRouter,this.versionId=t.versionId,this._isVersioned=this.versionEntity&&this.versionRouter,this._isEvaluated=!1,t.api&&e.each(t.api,function(t,e){this.meta.set(e,t)},this),this.isVersioned()&&require(["stratus","stratus.routers.version"],function(t){t.Instances[e.uniqueId("router.version_")]=new t.Routers.Version({model:this})}.bind(this)),t.manifest&&this.isNew()?this.save():this.trigger("refresh"),this._autoSave=t.autoSave,this._autoSave&&this.autoSave(this._autoSave),!0)},autoSave:function(e){return t.Chronos.toggle(this.saveJob,e)},refresh:function(){return this.isVersioned()&&!this.isEvaluated()||this.fetch(this.meta.size()>0?{data:this.meta.toObject()}:{}),!0},urlRoot:function(){var t="/Api";return t+=this.versionEntity&&this.versionId?"/"+e.ucfirst(this.versionEntity)+"/"+this.versionId:"","undefined"!=typeof this.collection?this.collection.url:t+"/"+e.ucfirst(this.entity)},toObject:function(){return e.clone(this.attributes)},toJSON:function(t){var e=this.meta.size()>0?{meta:this.meta.toJSON(),payload:i.RelationalModel.prototype.toJSON.call(this,t)}:i.RelationalModel.prototype.toJSON.call(this,t);return this.meta.size()>0&&this.meta.clearTemp(),e},isVersioned:function(){return"undefined"!=typeof this._isVersioned&&this._isVersioned},isEvaluated:function(){return"undefined"!=typeof this._isEvaluated&&this._isEvaluated},isHydrated:function(){return"undefined"!=typeof this._isHydrated&&this._isHydrated},hydrateRelations:function(t,i,s){return t.type=this[t.type],e.has(t,"reverseRelation")&&e.has(t.reverseRelation,"type")&&(t.reverseRelation.type=this[t.reverseRelation.type]),t.type},hydrateType:function(i,s,n){var o=null,r=null;e.has(i,"relatedModel")&&(o=i.relatedModel,r="model"),e.has(i,"collectionType")&&(o=i.collectionType,r="collection"),o&&("model"!==r||t.Models.has(o)?"collection"!==r||t.Collections.has(o)||t.Collections.set(o,t.Collections.Generic.extend({entity:o})):t.Models.set(o,t.Models.Generic.extend({entity:o})))},hydrateTypes:function(t,i,s){this.hydrateType(t,i,s),e.has(t,"reverseRelation")&&this.hydrateType(t.reverseRelation,i,s)},parse:function(i,s){if(this._isHydrated=!0,this._saving=!1,"object"==typeof i&&e.has(i,"payload")){e.has(i.meta,"relations"),1,this.attributes&&this.versionEntity&&e.has(i.payload[this.versionEntity],"id")&&this.versionId!==i.payload[this.versionEntity].id;var n=e.first(i.meta.status);return"SUCCESS"!==n.code?(t.Events.trigger("toast",new t.Prototypes.Toast({title:n.code,message:n.message,"class":"danger"})),t.Environment.get("production")||console.trace("Error:",i),this.trigger("error",this,s)):(t.Environment.get("production")||console.info("Success:",i),this.trigger("success",this,s)),i.payload}return this.attributes&&this.versionEntity&&e.has(i[this.versionEntity],"id")&&this.versionId!==i[this.versionEntity].id,i},save:function(t,s,n){var o;if(null===t||"object"==typeof t?(o=t,n=s):(o={})[t]=s,!this.isNew()&&!e.size(o)&&!e.size(this.patch))return!1;if(!this.isNew(),!1){e.size(o)&&this.set(o);var r=this.toJSON(),a=e.has(r,"payload")?r.payload:r;e.each(a,function(t,i){e.has(this.patch,i)||delete a[i]},this),t=r,s={patch:!0}}return i.Model.prototype.save.call(this,t,s,n)}}),t.Models.set("Generic",t.Models.Generic)});