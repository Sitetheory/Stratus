//     Stratus.Collections.Generic.js 1.0
//     Copyright (c) 2016 by Sitetheory, All Rights Reserved
//
//     All information contained herein is, and remains the
//     property of Sitetheory and its suppliers, if any.
//     The intellectual and technical concepts contained herein
//     are proprietary to Sitetheory and its suppliers and may be
//     covered by U.S. and Foreign Patents, patents in process,
//     and are protected by trade secret or copyright law.
//     Dissemination of this information or reproduction of this
//     material is strictly forbidden unless prior written
//     permission is obtained from Sitetheory.
//
//     For full details and documentation:
//     http://docs.sitetheory.io
!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","backbone","stratus.models.generic"],e):e(t.Stratus,t._,t.Backbone)}(this,function(t,e,i){t.Collections.Generic=i.Collection.extend({model:t.Models.Generic,meta:t.Prototypes.Collection,url:"/Api",entity:"Unknown",_isHydrated:!1,initialize:function(t){return e.has(this,"initialized")||(this.initialized=!1),!!this.initialized||void(t.initialize&&this.safeInitialize(t))},safeInitialize:function(i){return!!this.initialized||(this.initialized=!0,this.globals=new t.Prototypes.Collection,this.meta=new t.Prototypes.Collection,e.has(i,"entity")&&(this.entity=i.entity),e.has(i,"target")&&(this.target=i.target),e.has(i,"api")&&(this.meta.set("api",i.api),this.api=i.api),e.has(i,"prototype")&&(this.prototype=i.prototype),this.target&&(e.has(this.target,"entity")&&(this.target=[this.target]),e.each(this.target,function(t){t.entity&&t.id&&(this.url=this.url+"/"+e.ucfirst(t.entity)+"/"+t.id)},this)),this.entity&&"Unknown"!==this.entity&&(this.url=this.url+"/"+this.entity,this.globals.set("entity",this.entity)),this.globals.set("uid",e.uniqueId("collection_")),void this.refresh({reset:!0}))},isHydrated:function(){return"undefined"!=typeof this._isHydrated&&this._isHydrated},hydrateRelations:function(t,i,n){return t.type=this[t.type],e.has(t,"reverseRelation")&&e.has(t.reverseRelation,"type")&&(t.reverseRelation.type=this[t.reverseRelation.type]),t.type},hydrateType:function(i,n,s){var a=null,o=null;e.has(i,"relatedModel")&&(a=i.relatedModel,o="model"),e.has(i,"collectionType")&&(a=i.collectionType,o="collection"),a&&("model"!==o||t.Models.has(a)?"collection"!==o||t.Collections.has(a)||t.Collections.set(a,t.Collections.Generic.extend({entity:a})):t.Models.set(a,t.Models.Generic.extend({entity:a})))},hydrateTypes:function(t,i,n){this.hydrateType(t,i,n),e.has(t,"reverseRelation")&&this.hydrateType(t.reverseRelation,i,n)},parse:function(n,s){if(!e.has(n,"payload"))return n;if(this._isHydrated=!0,"undefined"!=typeof this.globals.get("entity")){"object"==typeof n.meta.relations&&e.each(n.meta.relations,this.hydrateRelations,i),t.Models.has(this.globals.get("entity"))||t.Models.set(this.globals.get("entity"),"object"==typeof n.meta.relations?t.Models.Generic.extend({relations:n.meta.relations}):t.Models.Generic.extend()),"object"==typeof n.meta.relations&&e.each(n.meta.relations,this.hydrateTypes,this);var a=function(t,i,n){e.has(i,n)&&t.set(n,i[n])};a(this.meta,n.meta,"editUrl"),a(this.meta,n.meta,"countCurrent"),a(this.meta,n.meta,"countTotal"),a(this.meta,n.meta,"pageCurrent"),a(this.meta,n.meta,"pageTotal"),a(this.meta,n.meta,"searchable"),this.model=t.Models.get(this.globals.get("entity"))}var o=e.first(n.meta.status);return"SUCCESS"!==o.code&&"NOTFOUND"!==o.code?(t.Events.trigger("toast",o.message,o.code,"danger"),t.Environment.get("production")||console.trace("Error:",n),this.trigger("error",this,n,s)):(t.Environment.get("production")||console.info("Success:",n),this.trigger("success",this,n,s)),n.payload},refresh:function(t){t=t&&"object"==typeof t?t:{},this.fetch(this.meta.has("api")?e.extend(t,{data:this.meta.get("api")}):t)},toJSON:function(t){var i=[];return this.each(function(t){var n=t.toJSON();i.push(e.has(n,"payload")?n.payload:n)}),this.meta.size()>0?{meta:this.meta.toJSON(),payload:e.clone(i)}:e.clone(i)},findParent:function(t,e,i){return"undefined"!=typeof i&&t.get(e)&&t.get(e).get("id")===i?t:t.get(e)?this.findParent(t.get(e),e,i):t},findParents:function(t,e,i){return"undefined"==typeof i&&(i=[]),t.has("id")&&i.push(t.get("id")),t.get(e)?this.findParents(t.get(e),e,i):i},compare:function(t,i,n,s,a){var o=null,r=!1,l=!1,h=null,d=null,c=null,u=null,f=null,y=null,p=!e.isUndefined(a)&&!e.isUndefined(t.get(a))&&!e.isUndefined(i.get(a));if(p&&(h=t.get(a),d=i.get(a)),h||e.isUndefined(t.get(n))||(h=t),d||e.isUndefined(i.get(n))||(d=i),p=p&&h&&d,p&&(c=!t.get(a),u=!i.get(a),e.isEqual(h.toObject(),d.toObject())?r=c||u:c||u||(c=e.isEqual(t.toObject(),i.get(a).toObject()),u=e.isEqual(i.toObject(),t.get(a).toObject()),r=c||u),!r&&(c||u||(l=e.isEqual(t.get(a).toObject(),i.get(a).toObject())),!l))){if(f=this.findParent(t,a),y=this.findParent(i,a),l=e.isEqual(f.toObject(),y.toObject())){var g=e.first(e.intersection(this.findParents(t,a),this.findParents(i,a))),m=this.findParent(t,a,g),b=this.findParent(i,a,g);e.isEqual(m.toObject(),y.toObject())||e.isEqual(f.toObject(),b.toObject())||(f=m,y=b)}h=f,d=y}return r?(h=c?1:0,d=u?1:0):(h=h?h.get(n):0,d=d?d.get(n):0),h>d?o=1:h<d&&(o=-1),o&&s?-o:o},comparator:function(t,e){var i=null;return i||(i=this.compare(t,e,"priority",!0,"parent")),i||(i=this.compare(t,e,"priority",!0)),i||(i=0),i},save:function(){console.warn("Saving collections is not fully implemented."),this.sync("update",this,{url:this.url})},saveOne:function(t){t.save()},saveAll:function(){this.models.each(this.saveOne,this)}})});