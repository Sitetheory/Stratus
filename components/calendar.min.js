!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","jquery","moment","angular","fullcalendar","stratus.components.calendar.timezones","ical","angular-material","moment-range"],factory):factory(root.Stratus,root._,root.jQuery,root.moment,root.angular)}(this,function(Stratus,_,jQuery,moment,angular,fullcalendar,timezones){const min=Stratus.Environment.get("production")?".min":"";Stratus.Components.Calendar={transclude:!0,bindings:{ngModel:"=",elementId:"@",eventSources:"@"},controller:function($scope,$attrs,$log,Collection){var tzData;this.uid=_.uniqueId("calendar_"),Stratus.Instances[this.uid]=$scope,$scope.elementId=$attrs.elementId||this.uid,Stratus.Internals.CssLoader(Stratus.BaseUrl+Stratus.BundlePath+"bower_components/fullcalendar/dist/fullcalendar"+min+".css"),$scope.options=$attrs.options&&_.isJSON($attrs.options)?JSON.parse($attrs.options):{},$scope.options.customButtons=$scope.options.customButtons||null,$scope.options.buttonIcons=$scope.options.buttonIcons||{prev:"left-single-arrow",next:"right-single-arrow",prevYear:"left-double-arrow",nextYear:"right-double-arrow"},$scope.options.header=$scope.options.header||{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},$scope.options.defaultView=$scope.options.defaultView||"month",$scope.options.defaultDate=$scope.options.defaultDate||null,$scope.options.nowIndicator=$scope.options.nowIndicator||!1,$scope.options.timezone=$scope.options.timezone||!1,$scope.options.eventForceAllDay=$scope.options.eventForceAllDay||!1,$scope.options.eventLimit=$scope.options.eventLimit||7,$scope.options.eventLimitClick=$scope.options.eventLimitClick||"popover",$scope.options.fixedWeekCount=$scope.options.fixedWeekCount||!1,$scope.options.firstDay=$scope.options.firstDay||0,$scope.options.weekends=$scope.options.weekends||!0,$scope.options.hiddenDays=$scope.options.hiddenDays||[],$scope.options.weekNumbers=$scope.options.weekNumbers||!1,$scope.options.weekNumberCalculation=$scope.options.weekNumberCalculation||"local",$scope.options.businessHours=$scope.options.businessHours||!1,$scope.options.RTL=$scope.options.RTL||!1,$scope.options.height=$scope.options.height||null,$scope.options.contentHeight=$scope.options.contentHeight||null,$scope.options.aspectRatio=$scope.options.aspectRatio||1.35,$scope.options.handleWindowResize=$scope.options.handleWindowResize||!0,$scope.options.windowResizeDelay=$scope.options.windowResizeDelay||100,$scope.eventSources=$attrs.eventSources&&_.isJSON($attrs.eventSources)?JSON.parse($attrs.eventSources):[],console.log("$scope.eventSources",$scope.eventSources),$scope.initialized=!1,$scope.fetched=!1,$scope.startRange=moment(),$scope.endRange=moment(),tzData=timezones,Object.keys(tzData).forEach(key=>{const icsData=timezones[key],parsed=ICAL.parse(`BEGIN:VCALENDAR\nPRODID:-//tzurl.org//NONSGML Olson 2012h//EN\nVERSION:2.0\n${icsData}\nEND:VCALENDAR`),comp=new ICAL.Component(parsed),vtimezone=comp.getFirstSubcomponent("vtimezone");ICAL.TimezoneService.register(vtimezone)}),$scope.collection=null,$scope.$watch("$ctrl.ngModel",function(data){data instanceof Collection&&($scope.collection=data)});let collectionWatcher=$scope.$watch("collection.completed",async function(completed){completed&&(collectionWatcher(),$log.log("collection:",$scope.collection),jQuery("#calendar").fullCalendar({customButtons:$scope.options.customButtons,buttonIcons:$scope.options.buttonIcons,header:$scope.options.header,defaultView:$scope.options.defaultView,defaultDate:$scope.options.defaultDate,nowIndicator:$scope.options.nowIndicator,timezone:$scope.options.timezone,eventLimit:$scope.options.eventLimit,eventLimitClick:$scope.options.eventLimitClick,fixedWeekCount:$scope.options.fixedWeekCount,firstDay:$scope.options.firstDay,weekends:$scope.options.weekends,hiddenDays:$scope.options.hiddenDays,weekNumbers:$scope.options.weekNumbers,weekNumberCalculation:$scope.options.weekNumberCalculation,businessHours:$scope.options.businessHours,isRTL:$scope.options.RTL,height:$scope.options.height,contentHeight:$scope.options.contentHeight,aspectRatio:$scope.options.aspectRatio,handleWindowResize:$scope.options.handleWindowResize,windowResizeDelay:$scope.options.windowResizeDelay}),await Promise.all($scope.eventSources.map(url=>$scope.addEventICSSource(url))),console.log("events all loaded!"),$scope.initialized=!0)},!0);$scope.addEventICSSource=async function(url){return new Promise(function(resolve){jQuery.get(`https://cors-anywhere.herokuapp.com/${url}`,function(urlResponse){console.log("fetched the events from",url);const events=new ICalExpander(urlResponse,{maxIterations:0}).jsonEventsFC(new Date("2018-01-24T00:00:00.000Z"),new Date("2020-01-26T00:00:00.000Z"));jQuery("#calendar").fullCalendar("addEventSource",{events:events}),resolve(events)})})};const ICalExpander=function(icsData,opts){opts=opts||{},this.maxIterations=null!=opts.maxIterations?opts.maxIterations:1e3,this.skipInvalidDates=null!=opts.skipInvalidDates&&opts.skipInvalidDates,this.jCalData=ICAL.parse(icsData),this.component=new ICAL.Component(this.jCalData),this.events=this.component.getAllSubcomponents("vevent").map(vevent=>new ICAL.Event(vevent)),this.skipInvalidDates&&(this.events=this.events.filter(evt=>{try{return evt.startDate.toJSDate(),evt.endDate.toJSDate(),!0}catch(err){return!1}}))};ICalExpander.prototype.between=function(after,before){const isEventWithinRange=function(startTime,endTime){return(!after||endTime>=after.getTime())&&(!before||startTime<=before.getTime())},getTimes=function(eventOrOccurrence){const startTime=eventOrOccurrence.startDate.toJSDate().getTime();let endTime=eventOrOccurrence.endDate.toJSDate().getTime();return eventOrOccurrence.endDate.isDate&&endTime>startTime&&(endTime-=1),{startTime:startTime,endTime:endTime}},exceptions=[];this.events.forEach(event=>{event.isRecurrenceException()&&exceptions.push(event)});const ret={events:[],occurrences:[]};return this.events.filter(e=>!e.isRecurrenceException()).forEach(event=>{const exDates=[];if(event.component.getAllProperties("exdate").forEach(exDateProp=>{const exDate=exDateProp.getFirstValue();exDates.push(exDate.toJSDate().getTime())}),event.isRecurring()){const iterator=event.iterator();let next,i=0;do{if(i+=1,next=iterator.next()){const occurrence=event.getOccurrenceDetails(next),{startTime:startTime,endTime:endTime}=getTimes(occurrence),isOccurrenceExcluded=-1!==exDates.indexOf(startTime),exception=exceptions.find(ex=>ex.uid===event.uid&&ex.recurrenceId.toJSDate().getTime()===occurrence.startDate.toJSDate().getTime());if(before&&startTime>before.getTime())break;isEventWithinRange(startTime,endTime)&&(exception?ret.events.push(exception):isOccurrenceExcluded||ret.occurrences.push(occurrence))}}while(next&&(!this.maxIterations||i<this.maxIterations));return}const{startTime:startTime,endTime:endTime}=getTimes(event);isEventWithinRange(startTime,endTime)&&ret.events.push(event)}),ret},ICalExpander.prototype.before=function(before){return this.between(void 0,before)},ICalExpander.prototype.after=function(after){return this.between(after)},ICalExpander.prototype.all=function(){return this.between()},ICalExpander.prototype.flattenRecurringEvent=function(e){let event=this.flattenEvent(e.item);return event.recurrenceId=e.recurrenceId.toJSDate(),event.startDate=e.startDate.toJSDate(),event.endDate=e.endDate.toJSDate(),event},ICalExpander.prototype.flattenEvent=function(e){return{startDate:e.startDate.toJSDate(),endDate:e.endDate.toJSDate(),description:e.description,summary:e.summary,attendees:e.attendees,organizer:e.organizer,sequence:e.sequence,uid:e.uid,location:e.location}},ICalExpander.prototype.jsonEvents=function(startRange,endRange){let events;const mappedEvents=(events=startRange&&endRange?this.between(startRange,endRange):this.all()).events.map(o=>this.flattenEvent(o)),mappedOccurrences=events.occurrences.map(o=>this.flattenRecurringEvent(o));return[].concat(mappedEvents,mappedOccurrences)},ICalExpander.prototype.flattenRecurringEventFC=function(e){let event=this.flattenEventFC(e.item);return event.start=e.startDate.toJSDate(),event.end=e.endDate.toJSDate(),event},ICalExpander.prototype.flattenEventFC=function(e){return{start:e.startDate.toJSDate(),end:e.endDate.toJSDate(),title:e.summary,id:e.uid,location:e.location}},ICalExpander.prototype.jsonEventsFC=function(startRange,endRange){let events;const mappedEvents=(events=startRange&&endRange?this.between(startRange,endRange):this.all()).events.map(o=>this.flattenEventFC(o)),mappedOccurrences=events.occurrences.map(o=>this.flattenRecurringEventFC(o));return[].concat(mappedEvents,mappedOccurrences)}},template:'<div id="{{ elementId }}">Calendar Stub<div id="calendar"></div></div>'}});